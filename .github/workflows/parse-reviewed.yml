name: Parse Reviewed Entry

on:
  issues:
    types: [labeled]

jobs:
  process:
    if: github.event.label.name == 'reviewed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Parse issue → data/*.yaml
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Parse YAML block OR form fields
            let yamlContent;
            const yamlMatch = body.match(/```ya?ml\s*\n([\s\S]*?)\n```/i);
            if (yamlMatch) {
              yamlContent = yamlMatch[1];
            } else {
              // EXTRACT ALL FIELDS - PERFECT FORMAT
              const doi = (body.match(/###\s*DOI\s*\n\s*([^\n]+)/i) || [])[1]?.trim() || '';
              const taxid = (body.match(/###\s*(?:NCBI Taxon ID|taxid)\s*\n\s*(\d+)/i) || [])[1];
              const individuals = (body.match(/###\s*(?:individuals|number of sequenced individuals)\s*\n\s*(\d+)/i) || [])[1];
              
              // FIXED data_url extraction
              const dataUrlMatch = body.match(/###\s*(?:URL|data_url|raw data)\s*\n\s*\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/i);
              const dataUrlText = dataUrlMatch ? dataUrlMatch[1] : '';
              const dataUrl = dataUrlMatch ? dataUrlMatch[2] : '';
              
              const method = (body.match(/###\s*method\s*\n\s*([^\n]+)/i) || [])[1]?.trim();
              const notesMatch = body.match(/###\s*Notes?\s*\n([\s\S]*?)(?=###|$)/i);
              const notes = notesMatch ? notesMatch[1].trim() : '';
              
              if (!taxid || !doi) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '❌ Need ### DOI and ### NCBI Taxon ID'
                });
                return;
              }
              
              // Build EXACT YAML format - NO YEAR FIELD
              yamlContent = `doi: ${doi}\ntaxid: ${taxid}`;
              if (individuals) yamlContent += `\nindividuals: ${individuals}`;
              if (dataUrl) yamlContent += `\ndata_url: [${dataUrlText || 'Data'}](${dataUrl})`;
              if (method) yamlContent += `\nmethod: ${method}`;
              if (notes) yamlContent += `\nnotes: |\n  ${notes.replace(/\n/g, '\n  ')}`;
            }
            
            // Filename uses taxid only (no year)
            const tax = (yamlContent.match(/taxid:\s*(\d+)/i) || [])[1] || 'entry';
            const base = `data/${tax}`;
            let filename = `${base}.yaml`;
            if (fs.existsSync(filename)) {
              const issueNum = issue.number;
              filename = `${base}_${issueNum}.yaml`;
            }

            fs.writeFileSync(filename, yamlContent);

            await exec.exec('git', ['config', '--global', 'user.name', 'github-actions[bot]']);
            await exec.exec('git', ['config', '--global', 'user.email', 'github-actions[bot]@users.noreply.github.com']);
            await exec.exec('git', ['add', filename]);
            await exec.exec('git', ['commit', '-m', `Add entry from Issue #${issue.number}`]);
            await exec.exec('git', ['push']);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `✅ **Saved!** \`${filename}\` [View](${context.repo.html_url}/blob/main/${filename})`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

      - name: Trigger deployment workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-build
name: Parse Reviewed Entry

on:
  issues:
    types: [labeled]

jobs:
  process:
    if: github.event.label.name == 'reviewed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue ‚Üí data/*.yaml
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');           
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            
            // Get issue body
            const { data: issueData } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            const body = issueData.body || '';

            console.log('Processing issue:', issueNumber);
            console.log('Body preview:', body.substring(0, 500));

            // Try to extract YAML block first (backward compatibility)
            let yamlText = null;
            const yamlMatch = body.match(/```ya?ml\s*\n([\s\S]*?)\n```/i);
            if (yamlMatch) {
              yamlText = yamlMatch[1];
              console.log('Found YAML block');
            } else {
              // Parse form fields
              console.log('Parsing form fields');
              const doiMatch = body.match(/doi[:\s]*`?([^\s\n`]+)/i) || 
                              body.match(/input name="doi" value="([^"]+)"/i);
              const taxMatch = body.match(/taxid[:\s]*`?(\d+)/i) || 
                              body.match(/input name="taxid" value="(\d+)"/i);
              const titleMatch = body.match(/title[:\s]*([^\n]+)/i);
              const yearMatch = body.match(/\b(19|20)\d{2}\b/) || 
                               body.match(/year[:\s]*`?(\d{4})/i);
              const authorsMatch = body.match(/authors[:\s]*([^\n]+)/i);

              const taxid = taxMatch ? taxMatch[1] : 'entry';
              const year = yearMatch ? yearMatch[1] : '2024';
              const doi = doiMatch ? doiMatch[1] : 'no-doi';

              yamlText = `taxid: ${taxid}\ndoi: ${doi}\nyear: ${year}\ntitle: "${titleMatch ? titleMatch[1].trim() : 'Untitled'}"\nauthors: "${authorsMatch ? authorsMatch[1].trim() : 'Unknown'}"`;
            }

            if (!yamlText) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ùå Could not extract data. Please include a `taxid` and `doi`.'
              });
              return;
            }

            // Generate filename
            const tax = (yamlText.match(/taxid:\s*(\d+)/i) || [])[1] || 'entry';
            const year = (yamlText.match(/\b(19|20)\d{2}\b/) || [])[0] || 'y';
            const base = `data/${tax}_${year}`.replace(/[^a-zA-Z0-9_\-\/]/g, '');
            let filename = `${base}.yaml`;
            if (fs.existsSync(filename)) filename = `${base}_${issueNumber}.yaml`;

            console.log('Writing:', filename);

            // Write file
            fs.writeFileSync(filename, yamlText);

            // Git setup
            await exec.exec('git', ['fetch', 'origin']);
            await exec.exec('git', ['checkout', 'main']);
            await exec.exec('git', ['pull', 'origin', 'main']);
            
            await exec.exec('git', ['config', 'user.name', 'github-actions[bot]']);
            await exec.exec('git', ['config', 'user.email', 'github-actions[bot]@users.noreply.github.com']);
            await exec.exec('git', ['add', filename]);

            // Commit if there are changes
            const commitResult = await exec.exec('git', ['commit', '-m', `Add study from Issue #${issueNumber}`], { ignoreReturnCode: true });
            if (commitResult.exitCode === 0) {
              console.log('‚úÖ Committed, now pushing...');
              
              try {
                const pushResult = await exec.exec('git', ['push', 'origin', 'main'], { 
                  ignoreReturnCode: true,  // ‚Üê ADD THIS
                  silent: false            // ‚Üê SHOW OUTPUT
                });
                
                console.log('PUSH EXIT CODE:', pushResult.exitCode);
                console.log('PUSH STDOUT:', pushResult.stdout);
                console.log('PUSH STDERR:', pushResult.stderr);
                
                if (pushResult.exitCode === 0) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `‚úÖ **Added!** Saved as \`${filename}\` ‚Üí [View file](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${filename})\n\nSite will rebuild shortly.`
                  });
                } else {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `‚ùå **Push failed!**\n\`\`\`\n${pushResult.stderr}\n\`\`\`\nFile created locally but not pushed.`
                  });
                }
              } catch (pushError) {
                console.error('PUSH CRASHED:', pushError);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `üí• **Push crashed!**\n\`\`\`\n${pushError.message}\n\`\`\``
                });
              }
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ÑπÔ∏è File \`${filename}\` already exists (no changes).`
              });
            }
        
            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

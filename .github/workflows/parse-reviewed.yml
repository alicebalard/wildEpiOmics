name: Parse Reviewed Entry

on:
  issues:
    types: [labeled]

jobs:
  process:
    if: github.event.label.name == 'reviewed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Get full history

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Parse issue → data/*.yaml
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
                      
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            
            // Get issue body
            const { data: issueData } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            const body = issueData.body || '';

            console.log('Processing issue:', issueNumber);

            // FIXED REGEXES for your issue format
            const doiMatch = body.match(/###\s*DOI\s*\n\s*([^\n]+)/i);
            const taxMatch = body.match(/###\s*(?:NCBI Taxon ID|taxid)\s*\n\s*(\d+)/i);
            const tissueMatch = body.match(/###\s*tissue\s*\n\s*([^\n]+)/i);
            const methodMatch = body.match(/###\s*method\s*\n\s*([^\n]+)/i);
            const individualsMatch = body.match(/###\s*number of sequenced individuals\s*\n\s*(\d+)/i);
            const notesMatch = body.match(/###\s*Notes\s*\n([\s\S]*?)(?=###|$)/i);

            const taxid = taxMatch ? taxMatch[1] : null;
            const entryYear = (body.match(/\b(19|20)\d{2}\b/) || ['2024'])[0];
            const doi = doiMatch ? doiMatch[1].trim() : 'no-doi';
            const tissue = tissueMatch ? tissueMatch[1].trim() : '';
            const method = methodMatch ? methodMatch[1].trim() : '';
            const individuals = individualsMatch ? individualsMatch[1] : '';
            const notes = notesMatch ? notesMatch[1].trim() : '';

            if (!taxid) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '❌ Missing NCBI Taxon ID. Please include `### NCBI Taxon ID\n12345`'
              });
              return;
            }

            const taxonInfo = {
              '69293': { order: 'Gasterosteiformes', class: 'Actinopterygii' }
            };

            const studyData = {
              taxid,
              doi,
              year: entryYear,
              method,
              tissue,
              individuals: parseInt(individuals) || 0,
              title: notes.split('\n')[0] || 'Untitled study',
              authors: 'Unknown authors',
              url: doi.startsWith('10.') ? `https://doi.org/${doi}` : doi,
              order: taxonInfo[taxid]?.order || 'Unknown',
              class: taxonInfo[taxid]?.class || 'Unknown'
            };
            
            const yamlText = yaml.dump(studyData, { indent: 2 });

            // Generate safe filename
            const fileYear = entryYear.slice(-2);
            const base = `data/${taxid}_${fileYear}`;
            let filename = `${base}.yaml`;
            if (fs.existsSync(filename)) filename = `${base}_${issueNumber}.yaml`;

            console.log('Writing:', filename);
            fs.writeFileSync(filename, yamlText);

            // COMPLETE Git workflow
            await exec.getExecOutput('git', ['config', 'user.name', 'github-actions[bot]']);
            await exec.getExecOutput('git', ['config', 'user.email', 'github-actions[bot]@users.noreply.github.com']);
            await exec.getExecOutput('git', ['add', '.']);
            
            const commitResult = await exec.getExecOutput('git', ['commit', '-m', `Add study #${issueNumber}: ${taxid}`]);
            console.log('Commit exit code:', commitResult.exitCode);
            
            if (commitResult.exitCode === 0) {
              const pushResult = await exec.getExecOutput('git', ['push', 'origin', 'HEAD:main']);
              console.log('Push exit code:', pushResult.exitCode);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `✅ **Added!** \`${filename}\` → [View file](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${filename})\n\nSite will rebuild shortly.`
              });
            } else {
              console.log('No changes to commit');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ℹ️ No new data to add (file exists)`
              });
            }

            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

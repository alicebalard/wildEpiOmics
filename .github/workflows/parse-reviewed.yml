name: Parse Reviewed Entry

on:
  issues:
    types: [labeled]

jobs:
  process:
    if: github.event.label.name == 'reviewed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract and write YAML file
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body || '';

            // Prefer fenced YAML if the user pasted one
            let yamlContent;
            const yamlMatch = body.match(/```ya?ml[\r\n]+([\s\S]*?)```/i);

            if (yamlMatch) {
              yamlContent = yamlMatch[1];
            } else {
              const H = (label) =>
                new RegExp(`###\\s*${label}\\s*[\r\n]+([^ \r\n][^ \r\n]*)`, "i");

              const doiRaw = (body.match(H("(?:article DOI|DOI)")) || [])[1] || "";
              const doi = doiRaw.replace(/^https?:\/\/(dx\.)?doi\.org\//i, "").trim();
              
              const taxid = (body.match(H("(?:NCBI Taxon ID|taxid)")) || [])[1];
              
              const individuals = (body.match(H("(?:individuals|number of sequenced individuals)")) || [])[1];
              
              const data_url_raw = (body.match(H("(?:URL of raw data|data_url)")) || [])[1] || "";
              const data_url = data_url_raw.replace(/\[.*?\]\((.*?)\)/, '$1').replace(/\s*\[[^\]]*\]\s*/, '').trim();
              
              const tissue = (body.match(H("(?:tissue sampled|tissue)")) || [])[1] || "";
              
              const method = (body.match(H("method")) || [])[1] || "";
              
              const image_url_raw = (body.match(H("(?:Image URL|image_url)")) || [])[1] || "";
              const image_url = image_url_raw.replace(/\[.*?\]\((.*?)\)/, '$1').replace(/\s*\[[^\]]*\]\s*/, '').trim();

              const image_credit_raw = (body.match(H("(?:Image Credit|image_credit)")) || [])[1] || "";
              const image_credit = image_credit_raw.replace(/\[.*?\]\((.*?)\)/, '$1').trim();
              
              if (image_credit) yamlContent += `\nimage_credit: "${image_credit}"`;

              const notesMatch = body.match(/###\s*main question\(s\) of the study\s*[\r\n]+([\s\S]*?)(?=###\s|\s*$)/i);
              const notes = notesMatch ? notesMatch[1].replace(/^\s+|\s+$/g, '') : "";

              if (!taxid || !doi) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '❌ Need ### DOI and ### NCBI Taxon ID'
                });
                return;
              }

              yamlContent = `doi: ${doi}\ntaxid: ${taxid}`;
              if (individuals) yamlContent += `\nindividuals: ${individuals}`;
              if (data_url) yamlContent += `\ndata_url: ${data_url}`;
              if (tissue) yamlContent += `\ntissue: ${tissue}`;
              if (method) yamlContent += `\nmethod: ${method}`;
              if (image_url) yamlContent += `\nimage: ${image_url}`;
              if (notes) yamlContent += `\nnotes: |\n  ${notes.split('\n').map(line => '  ' + line.trim()).join('\n')}`;
            }

            const tax = (yamlContent.match(/taxid:\s*(\d+)/i) || [])[1] || 'entry';
            const base = `data/${tax}`;
            let filename = `${base}.yaml`;
            if (fs.existsSync(filename)) filename = `${base}_${issue.number}.yaml`;

            fs.writeFileSync(filename, yamlContent);
            core.setOutput("filename", filename);

      - name: Commit YAML file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.extract.outputs.filename }}
          git commit -m "Add entry from Issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Saved!** \`${process.env.FILENAME}\``
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
        env:
          FILENAME: ${{ steps.extract.outputs.filename }}

      - name: Trigger deployment workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-build
